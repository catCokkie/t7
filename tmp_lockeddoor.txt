using Godot;
using SilentTestimony.Interfaces;
using SilentTestimony.Systems;

namespace SilentTestimony.World
{
    /// <summary>
    /// éœ€è¦é’¥åŒ™æ‰èƒ½å¼€å¯çš„é—¨ã€‚å®ç?IInteractable æ¥å£
    /// </summary>
    public partial class LockedDoor : StaticBody2D, IInteractable
    {
        [Export] public string RequiredKeyItemID { get; set; } = string.Empty;
        [Export] public NodePath AnimationPlayerPath { get; set; } = default;

        private bool _isOpened;

        public string GetInteractPrompt()
        {
            if (_isOpened)
            {
                return "é€šè¿‡";
            }

            return string.IsNullOrEmpty(RequiredKeyItemID)
                ? "æ‰“å¼€"
                : "ä½¿ç”¨é’¥åŒ™";
        }

        public void Interact(Node2D interactor)
        {
            if (_isOpened)
            {
                return;
            }

            var inventory = GetNodeOrNull<InventoryManager>("/root/InventoryManager");
            if (inventory == null)
            {
                GD.PushWarning("LockedDoor: æœªæ‰¾åˆ?InventoryManagerï¼Œå…¨å±€èƒŒåŒ…ç³»ç»Ÿå¯èƒ½æœªåˆå§‹åŒ–ã€?);
                return;
            }

            if (string.IsNullOrEmpty(RequiredKeyItemID) || inventory.HasItem(RequiredKeyItemID))
            {
                OpenDoor();
            }
            else
            {
                GD.Print($"{Name}: é—¨è¢«é”ä½äº†ï¼Œéœ€è¦ç‰©å“?{RequiredKeyItemID}ã€?);
            }
        }

        private void OpenDoor()
        {
            _isOpened = true;
            GD.Print($"{Name}: é—¨å·²æ‰“å¼€ã€?);

            AnimationPlayer animationPlayer = null;
            if (!AnimationPlayerPath.IsEmpty)
            {
                animationPlayer = GetNodeOrNull<AnimationPlayer>(AnimationPlayerPath);
            }
            else
            {
                animationPlayer = GetNodeOrNull<AnimationPlayer>("AnimationPlayer");
            }

            animationPlayer?.Play("Open");

            // ç®€å•å¤„ç†ï¼šç¦ç”¨ç¢°æ’å¹¶éšè—ç²¾ç?
            CollisionLayer = 0;
            CollisionMask = 0;
            var sprite = GetNodeOrNull<Node2D>("Sprite2D");
            sprite?.SetDeferred("visible", false);
        }
    }
}

